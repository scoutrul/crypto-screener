# Многоуровневая система фиксации прибыли

## Обзор

Многоуровневая система фиксации прибыли представляет собой продвинутый подход к управлению рисками и максимизации прибыли в виртуальной торговой системе. Система автоматически фиксирует прибыль на различных уровнях с разными объёмами и целями.

## Архитектура

### Доменные сущности

#### TradeLevel
Представляет один уровень фиксации прибыли с следующими характеристиками:
- `levelNumber` - номер уровня (1-4)
- `volumeAmount` - объём на уровне в долларах
- `targetPrice` - целевая цена для выполнения уровня
- `tradeType` - тип сделки (Long/Short)
- `isExecuted` - статус выполнения
- `executionPrice` - цена выполнения
- `profitLoss` - прибыль/убыток уровня
- `commission` - комиссия уровня

### Сервисы

#### MultiLevelTradingService
Основной сервис для управления многоуровневой системой:

**Методы:**
- `createTradeLevels()` - создание уровней для сделки
- `checkLevelExecution()` - проверка выполнения уровней
- `calculateTotalCommission()` - расчёт общей комиссии
- `calculateNetProfit()` - расчёт чистой прибыли
- `getLevelsStatistics()` - получение статистики по уровням
- `isTradeCompleted()` - проверка завершения сделки

## Конфигурация

### Параметры системы

```javascript
{
  multiLevelEnabled: true,           // Включение многоуровневой системы
  initialVolume: 1000,              // Начальный объём сделки ($1000)
  commissionPercent: 0.0003,        // Комиссия биржи (0.03%)
  level2VolumePercent: 0.2,         // 20% для уровня 2
  level3VolumePercent: 0.4,         // 40% для уровня 3
  level4VolumePercent: 0.4,         // 40% для уровня 4
  level2TargetPercent: 0.0006,      // 0.06% для безубытка с комиссией
  level3TargetPercent: 0.05,        // 5% для уровня 3
  level4TargetPercent: 0.05         // 5% для уровня 4
}
```

## Уровни фиксации

### Уровень 1 - Вход (100% объёма)
- **Объём**: $1000 (100% от начального объёма)
- **Цель**: Цена входа
- **Назначение**: Базовый уровень для отслеживания

### Уровень 2 - Безубыток с комиссией (20% объёма)
- **Объём**: $200 (20% от начального объёма)
- **Цель**: Компенсация комиссии (0.06% = 0.03% * 2)
- **Назначение**: Гарантированная безубыточность

### Уровень 3 - Фиксация прибыли (40% объёма)
- **Объём**: $400 (40% от начального объёма)
- **Цель**: 5% прибыли
- **Назначение**: Первая фиксация прибыли

### Уровень 4 - Фиксация прибыли (40% объёма)
- **Объём**: $400 (40% от начального объёма)
- **Цель**: 5% прибыли
- **Назначение**: Вторая фиксация прибыли

## Логика работы

### Создание сделки
1. При создании сделки автоматически создаются 4 уровня
2. Каждый уровень имеет свой объём и целевую цену
3. Уровни рассчитываются с учётом типа сделки (Long/Short)

### Отслеживание цен
1. Система мониторит текущую цену каждые 30 секунд
2. При достижении целевой цены уровень автоматически выполняется
3. Рассчитывается прибыль/убыток с учётом комиссии

### Выполнение уровней
1. **Уровень 1**: Выполняется сразу при входе
2. **Уровень 2**: Выполняется при достижении безубытка
3. **Уровень 3**: Выполняется при достижении 5% прибыли
4. **Уровень 4**: Выполняется при достижении 5% прибыли

### Завершение сделки
- Сделка считается завершённой, когда все 4 уровня выполнены
- Рассчитывается общая чистая прибыль с учётом всех комиссий

## Расчёты

### Комиссия
- Комиссия рассчитывается от общей суммы (объём + прибыль)
- Ставка комиссии: 0.03% за сделку
- Общая комиссия = (объём + прибыль) × 0.0003

### Прибыль
- Валовая прибыль = (цена выполнения - цена входа) × объём
- Чистая прибыль = валовая прибыль - комиссия
- Процент прибыли = (чистая прибыль / объём) × 100

### Безубыток
- Уровень 2 обеспечивает безубыточность с учётом комиссии
- Целевая цена = цена входа ± 0.06% (компенсация комиссии)

## Уведомления

### Новые сделки
- Отображается информация о всех 4 уровнях
- Показываются объёмы и целевые цены
- Указывается статус многоуровневой системы

### Выполнение уровней
- Уведомление о каждом выполненном уровне
- Показывается прибыль/убыток уровня
- Отображается комиссия и чистая прибыль

### Завершённые сделки
- Детальная статистика по всем уровням
- Общая комиссия и чистая прибыль
- Прогресс выполнения (X/4 уровней)

## Интеграция с существующей системой

### Совместимость
- Система полностью совместима с существующими сделками
- Старые сделки автоматически получают многоуровневую систему
- Обратная совместимость с обычной системой безубытка

### Переключение режимов
- Можно включить/выключить многоуровневую систему
- При отключении используется обычная система безубытка
- Настройки применяются к новым сделкам

## Тестирование

### Тестовый скрипт
```bash
node scripts/test-multi-level-system.js
```

### Проверяемые аспекты
- Создание уровней для Long/Short сделок
- Выполнение уровней при достижении целевых цен
- Расчёт комиссий и чистой прибыли
- Статистика и прогресс выполнения
- Уведомления и сообщения

## Преимущества

### Риск-менеджмент
- Гарантированная безубыточность на уровне 2
- Постепенная фиксация прибыли
- Защита от резких движений цены

### Максимизация прибыли
- Равномерное распределение объёмов
- Множественные точки фиксации
- Оптимизация под различные рыночные условия

### Автоматизация
- Полностью автоматическая система
- Минимальное вмешательство трейдера
- Детальная отчётность и уведомления

## Мониторинг

### Статистика
- Количество выполненных уровней
- Общая и чистая прибыль
- Комиссии по уровням
- Процент завершённых сделок

### Отчёты
- Детальная статистика по каждому уровню
- Сравнение с обычной системой
- Анализ эффективности стратегии 