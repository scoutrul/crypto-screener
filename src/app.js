/**
 * –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
 */
const AppConfig = require('./infrastructure/config/AppConfig');
const CoinGeckoRepository = require('./infrastructure/repositories/CoinGeckoRepository');
const TelegramNotificationRepository = require('./infrastructure/repositories/TelegramNotificationRepository');
const MarketAnalysisService = require('./domain/services/MarketAnalysisService');
const NotificationService = require('./application/services/NotificationService');
const SendMarketSummaryUseCase = require('./application/use-cases/SendMarketSummaryUseCase');

/**
 * –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
 */
class DependencyContainer {
  constructor() {
    this.config = null;
    this.coinRepository = null;
    this.notificationRepository = null;
    this.marketAnalysisService = null;
    this.notificationService = null;
    this.sendMarketSummaryUseCase = null;
  }

  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
   */
  async initialize() {
    try {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Crypto Screener —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π...');

      // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      console.log('üìã –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
      this.config = new AppConfig();
      
      if (!this.config.validate()) {
        throw new Error('Invalid configuration');
      }
      
      console.log(`‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (${this.config.app.environment} —Ä–µ–∂–∏–º)`);

      // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
      console.log('üóÑÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤...');
      this.coinRepository = new CoinGeckoRepository();
      this.notificationRepository = new TelegramNotificationRepository();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
      const isCoinGeckoAvailable = await this.coinRepository.isAvailable();
      const isNotificationAvailable = await this.notificationRepository.isAvailable();
      
      console.log(`‚úÖ CoinGecko API: ${isCoinGeckoAvailable ? '–¥–æ—Å—Ç—É–ø–µ–Ω' : '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}`);
      console.log(`‚úÖ –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${isNotificationAvailable ? '–¥–æ—Å—Ç—É–ø–µ–Ω' : '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}`);

      // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
      console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...');
      this.marketAnalysisService = new MarketAnalysisService();
      console.log('‚úÖ MarketAnalysisService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

      // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      console.log('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      this.notificationService = new NotificationService(
        this.notificationRepository,
        this.marketAnalysisService
      );
      console.log('‚úÖ NotificationService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

      // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è use cases
      console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è use cases...');
      this.sendMarketSummaryUseCase = new SendMarketSummaryUseCase(
        this.coinRepository,
        this.notificationService
      );
      console.log('‚úÖ SendMarketSummaryUseCase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

      console.log('üéâ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!');
      
      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
      await this.notificationService.sendStartupNotification();
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error.message);
      throw error;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
   */
  getConfig() {
    return this.config;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–æ–Ω–µ—Ç
   */
  getCoinRepository() {
    return this.coinRepository;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   */
  getNotificationRepository() {
    return this.notificationRepository;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞
   */
  getMarketAnalysisService() {
    return this.marketAnalysisService;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   */
  getNotificationService() {
    return this.notificationService;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å use case –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–≤–æ–¥–∫–∏ —Ä—ã–Ω–∫–∞
   */
  getSendMarketSummaryUseCase() {
    return this.sendMarketSummaryUseCase;
  }
}

/**
 * –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */
class CryptoScreenerApp {
  constructor() {
    this.container = new DependencyContainer();
  }

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   */
  async start() {
    try {
      await this.container.initialize();
      console.log('üöÄ Crypto Screener –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
      
      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
      global.cryptoScreener = {
        config: this.container.getConfig(),
        coinRepository: this.container.getCoinRepository(),
        notificationRepository: this.container.getNotificationRepository(),
        marketAnalysisService: this.container.getMarketAnalysisService(),
        notificationService: this.container.getNotificationService(),
        sendMarketSummaryUseCase: this.container.getSendMarketSummaryUseCase()
      };
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error.message);
      process.exit(1);
    }
  }

  /**
   * –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   */
  async stop() {
    console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Crypto Screener...');
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    console.log('‚úÖ Crypto Screener –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
module.exports = {
  CryptoScreenerApp,
  DependencyContainer
};

// –ï—Å–ª–∏ —Ñ–∞–π–ª –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
  const app = new CryptoScreenerApp();
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  process.on('SIGINT', async () => {
    console.log('\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT');
    await app.stop();
    process.exit(0);
  });

  process.on('SIGTERM', async () => {
    console.log('\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM');
    await app.stop();
    process.exit(0);
  });

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  app.start().catch(error => {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error.message);
    process.exit(1);
  });
} 